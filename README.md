# EWX-TelegramBot
TelegramBot that takes files to post from Yandex.Disc

This project is dead, i won't use it anymore, but you can take it for your ideas.

Description on an original language:
После установки программы (Да, программа имеет собственный установщик) и первом запуске программа работает в холостую. То бишь она работает, но делает ровным счетом ничего, так как для работы программе нужны стартовые данные, как минимум токен доступа Telegram. Указав в ручном порядке токен бот частично готов к работе. Минимум, необходимый для работы – Telegram Bot API Token, Yandex Token и идентификатор канала\группы, в которой будут публиковаться записи.

Указав только минимум бот не сможет выполнять команды при помощи личных сообщений. Чтобы активировать эту возможность необходимо добавить пользователя в список администраторов, сделать это тоже достаточно просто. Необходимо выполнить команду генерации секретного кода. Если список администраторов на момент выполнения пуст, то бот откроет в браузере ссылку на диалог с собой, в котором нужно отправить боту сгенерированный секретный код.

Можно любым другим способом отправить боту указанный секретный код. Сравнив полученный в личных сообщениях код и хранящийся в программе бот или добавит отправителя в список администраторов, если код совпадает, или проигнорирует сообщения, если код не совпадает.

Код представляет собой набор случайных символов длиной по умолчанию в 32 символа (Можно изменить при помощи команды на любую длину от 10 до 128). Каждый сгенерированный код уникален и существует ровно до момента его успешного использования либо ручного отзыва при помощи выполнения команды администратором.

Авторизация в Яндекс возможна только с компьютера, на котором запущена инстанция бота (Компьютер далее будет называть сервером), так как принцип работы модуля авторизации для external-приложений самого Яндекса не позволяет упростить авторизацию. Выполнив в командной строке бота команду авторизации бота, происходит несколько на первый взгляд простых операций:

1. Запуск локального HTTP сервера, прослушивающего все входящие запросы на 3000 порт, за это отвечает модуль CallbackListener;
2. После запуска HTTP сервера открывается popup-окно авторизации в стандартном браузере ОС семейства Windows – Internet Explorer. Этот выбор сделан исходя из того, что этот браузер есть на абсолютно любом издании Windows, за исключением вариантов, когда пользователь путем махинаций с разрешениями и длительных танцев с бубном удалил встроенный браузер;
3. В открывшемся окне авторизуемся в корневой сервис ученых записей Яндекс – Яндекс.Паспорт, после чего Яндекс отправляет ответный запрос на локальный сервер;
4. CallbackListener получив запрос выполняет его обработку и пару махинаций с преобразованием входящего запроса. Без махинаций не обойтись, так как формируя ответ Яндекс «запихивает» учетные данные бота в хеш-область запроса, которую способен увидеть только браузер. Путем махинаций происходит преобразование хеш-области в область параметров, которую уже способен увидеть HTTP сервер. Получив уже преобразованный запрос CallbackListener путем парсинга достает из запроса токен доступа и записывает его в свою конфигурацию;
5. После выполнения всех вышеуказанных операций popup-окно закрывается (Если не было закрыто пользователем), далее отключается поток CallbackListener.
 
Выполнив эти действия, программа начинает сканирование облачного диска на предмет наличия папки приложения, если она обнаружена, то начинается сканирование папок с данными. Если папка приложения или вложенные папки данных не созданы, то программа отразит это в командной строке и создаст папки самостоятельно. Если папки созданы и имеют какой-то контент, то программа начнет синхронизацию. В данном случае под синхронизацией понимается загрузка содержимого папок в локальное хранилище (%AppData%\EWXTelegramBot\localdataholder).

Все данные для публикаций программа хранит локально в угоду скорости публикации, чтобы при наступлении момента публикации не затрачивать время на загрузку данных перед публикацией и последующую выгрузку на сервера Telegram. Если на сервере наблюдаются проблемы со скоростью соединения, то это может стать причиной запоздания публикации хотя бы на минуту, а это недопустимо лично для меня.

Подключение бота к каналу\группе происходит одним из двух способов^
1. При помощи одной команды бот начинает обработку событий добавления в канал или группу. То бишь выполняете команду и добавляете бота в нужный диалог, предоставляя ему права администратора. Бот обработав событие добавляет канал\группу в список получателей публикаций. Без команды это не сработает, бот проигнорирует событие и самовольно покинет канал\группу при следующей итерации главного слушающего потока. Это сделано для защиты от добавления бота в какой-либо канал\группу любым другим пользователем, не являющегося администратором бота;
2. При помощи другой команды, которая сгенерирует секретный код для добавления в канал\группу. Работает точно так же, как с добавлением администратора, но придется отправить в канал сгенерированный код на несколько секунд, пока бот не уведомит о том, что указанный диалог добавлен в список получателей. Сам код так же отзывается после успешного использования или ручного отзыва администратором.
Под публикацией бот понимает отправку в канал\группу изображения и аудиозаписи, в лучших традициях публикаций ВКонтакте. Сама публикация выполняется строго один раз в сутки по воле заказчика в указанное время. Время указывается с точностью до минуты в формате ЧЧ:ММ. В программе можно настроить несколько параметров технической части, о них сказано в блоке конфигурации.

Выполняя публикацию программа запрашивает от одного из модулей информацию о наличии неиспользованных материалов и если таковые имеются, то запрашивает пути к любому неиспользованному изображению и любой неиспользованной аудиозаписи. Эти данные передаются в метод формирования публикации. После загрузки материалов на сервер Telegram выполняется их публикация в диалоги из списка получателей, после чего программа отмечает момент публикации, для запрета повторной публикации, уведомляет администраторов о том, что публикация сделана, проверяет наличие новых материалов на облаке Яндекса и проверку наличия обновлений самого бота (Да, программа имеет свой updater).

В ранних версиях конфигурация приложения хранилась в собственном формате и обрабатывалась самописным парсером, в дальнейшем от этого я отказался, переведя всю конфигурацию в JSON. Абсолютно вся конфигурация хранится в формате JSON. Все данные программы хранятся в локальной папке приложения (%AppData%\EWXTelegramBot), которая содержит в себе две папки и два файла конфигурации. Из папок это папка localdataholder, содержащая в себе две подпапки audios и images. Что они хранят, думаю, объяснять не требуется. Папка logs хранит в себе журнал работы программы. Каждая сессия равняется одному файлу записей журнала, но выполни команду перезапуска модуля логгера программа начнет записывать новый лог в новый файл без перезагрузки программы. Это не баг, так задумано.

Один из двух файлов – configuration.ewx, который хранит в себе все настройки программы: токены доступа, время публикации, момент последней публикации, длину секретного кода, списки получателей и администраторов и прочие технические параметры.

Второй файл – localdataholder.ewx, хранящий в себе информацию о синхронизированной части материалов, а именно записи о том, какие материалы опубликованы, а какие нет, в общем плане вырисовывается информация о составе текущего локального хранилища.

Описание параметров, хранящихся в configuration.ewx:

1. postAgain – Параметр, хранящий в себе булево значение. Параметр отвечает за возможность повторного использования материалов в случае, если неиспользованных материалов не осталось;
2. allowController – Технический параметр, записывающий статус последней сессии в булевом формате, необходим для автозапуска потока главного модуля после рестарта;
3. allowLongpoll – Технический параметр, записывающий статус последней сессии в булевом формате, необходим для автозапуска модуля обработки входящих сообщений и событий после рестарта;
4. refreshCooldown – Целочисленный параметр, отвечающий за интервал проверки времени публикации в секундах;
5. deviation – Целочисленный параметр, указывающий на допустимую погрешность времени публикации в минутах;
6. timeout – Целочисленный параметр, отвечающий за частоту опроса сервера обновлений Telegram в секундах. Раз в указанное количество секунд программа выполняет опрос серверов Telegram на предмет наличия каких-либо событий;
7. secretLength – Целочисленный параметр, отвечающий за количество символов в сгенерированных программой секретных кодах;
8. offset – Технический параметр, записывающий идентификатор последнего обработанного события на серверах Telegram. Необходим для корректного получения актуальных событий. Параметр хранится в формате long;
9. syncCooldown – Целочисленный параметр, отвечающий за частоту опроса облака Яндекс на наличие новых материалов в минутах. Параметр является рудиментарным, но пока принято решение его не удалять;
10. lastSync – Технический целочисленный параметр формата long, записывающий время последней синхронизации с облаком Яндекса в миллисекундах. Параметр является рудиментарным, но пока принято решение его не удалять;
11. lastPostDate – Строковый параметр, хранящий в себе дату последней публикации. Поскольку публикация выполняется только раз в день, то достаточно хранить для сравнения только дату;
12. telegramToken – Строковый параметр, хранящий в себе токен доступа Telegram Bot API, необходимый для взаимодействия с сервисами Telegram;
13. myself – Технический строковый параметр, хранящий в себе имя бота. Я вряд ли объясню, для какой цели этот параметр необходим, но работа без него стабильности не гарантирует;
14. secret – Строковый параметр, хранящий в себе сгенерированный в предыдущей сессии секретный код администратора, если он не был использован до перезапуска сервера или программы;
15. channelSecret – Строковый параметр, хранящий в себе сгенерированный в предыдущей сессии секретный код канала\группы, если он не был использован до перезапуска сервера или программы;
17. yandexToken – Строковый параметр, хранящий в себе токен доступа к сервисам Яндекс. Необходим для взаимодействия с сервисами Яндекс;
18. postTime – Параметр, хранящий в себе время публикации. Внутри конфигурации параметр может выглядеть примерно так - DAA=, мы лицезреем это в связи с тем, что конфигурация является строковым файлом и примерно так программа представляет в строковом формате массив байт. Внутри программы время хранится в формате byte[]. Программа без ошибок считывает данный параметр из конфигурации при перезапуске;
19. telegramPeers – Параметр, представляющий собой строковый массив, хранящий в себе список идентификаторов диалогов-получателей;
20. telegramAdmins – Параметр, хранящий в себе массив объектов формата TLAdmin, то бишь список администраторов бота. Объект TLAdmin в строковом представлении конфигурации выглядит следующим образом - {"username":"ewerestr","id":0123456789}.

Файл localdataholder.ewx не нуждается в детальном описании, так как лезть в него вручную не рекомендуется. Любое изменение может привести к нестабильной работе программы или же вылетам. Да и описывать в нем нечего. Весь файл хранит в себе четыре строковых массива: postedImageList, unpostedImageList, postedAudioList и unpostedAudioList.

Список доступных команд:
1. start – Команда, выполняющая запуск всех компонентов программы. После выполнения этой команды бот активирует весь свой функционал и начинает работать согласно своему назначению. Программа прописывается единожды, после стартовой настройки. При последующих перезагрузках она потребуется только в случае возникновения неполадок;
2. stop – Команда для безопасной остановки работы программы. При выполнении команды происходит полное сохранение всех данных программы и завершение ее работы;
3. saveAll – Команда, выполняющая ручное сохранение всех данных программы на момент выполнения;
4. setPostTime – Команда, задающая время, в которое бот будет публиковать записи. Принимает параметр в формате ЧЧ:ММ. Пример: setPostTime 10:00;
5. setDeviation – Команда, задающая максимально допустимую погрешность времени публикации в минутах. Принимает целочисленный параметр равный количеству минут погрешности. Пример: setDeviation 1;
6. setRefreshCooldown – Команда, задающая интервал сверки времени в секундах. Принимает целочисленный параметр равный количеству секунд интервала. Пример: setRefreshCooldown 15;
7. setLongpollTimeout – Команда, задающая частоту опроса сервера обновлений Telegram в секундах. Принимает целочисленный параметр равный количеству секунд интервала. Пример: setLongpollTimeout 5;
8. setTelegramToken – Команда, задающая в ручном порядке токен доступа к сервисам Telegram. Принимает строковый параметр, равный токену доступа. Пример: setTelegramToken 0123456789:QWeRTyUI_oPAsdFg;
9. setSecretLength – Команда, задающая количество символов в генерируемых программой секретных кодах, принимает целочисленный параметр равный количеству символов и варьирующийся от 10 до 128. Пример: setSecretLength 32;
10. generateSecret – Команда, генерирующая секретный код администратора. Пример генерируемого кода: a;xL]zpn&=YC*@4YF1p&ffAVHyH)f4f+;
11. generateChannelSecret – Команда, генерирующая секретный код канала\группы. Пример генерируемого кода: d!OlZ[H2]j]lfI?p(W6qKT((}$U_X|h8;
12. setInvites – Команда, активирующая слушатель события добавления бота в канал\группу. Принимает целочисленный параметр равный количеству каналов\групп, в которые будет добавлен бот. Пример: setInvites 1. Внимание, это небезопасный способ. Если указать параметр и не добавить бота в канал\группу в течение нескольких минут, то его может добавить любой другой пользователь в любую другую группу или канал и бот посчитает это за то самое событие, которое вы ему указали слушать;
13. revokeSecret – Команда, отзывающая текущий секретный код администратора. После выполнения этой команды использовать крайний код будет невозможно;
14. revokeChannelSecret – Команда, отзывающая текущий секретный код канала. После выполнения этой команды использовать крайний код будет невозможно;
15. cleanInvites – Команда, аннулирующая текущие приглашения, иными словами, если бота добавить в канал\группу, то он это проигнорирует и не будет отправлять туда публикации;
16. forcepost – Команда, выполняющая немедленную публикацию независимо от текущего времени и статусу публикации на текущий день. В основном использовалась в тестировании, но оставлена, так как может быть полезна в некоторых моментах;
17. authYandex – Команда, запускающая алгоритм авторизации в сервисах Яндекс. Внимание, выполнение команды невозможно при помощи личных сообщений боту, только из командной строки инстанции;
18. forceSync – Команда, выполняющая немедленную синхронизацию с облаком Яндекс. Использовалась для тестирования, но оставлена, так как может быть полезна в некоторых моментах;
19. getStatus – Техническая команда, используемая для получения краткого статуса программы на момент выполнения;
20. getDetStatus – Техническая команда, используемая для получения детального статуса программы на момент выполнения;
21. getUpdates – Команда, выполняющая проверку и загрузку обновлений в случае, если таковые имеются;
22. installUpdates – Команда, выполняющая установку обновлений, загруженных при помощи предыдущей команды или при плановой проверке обновлений;
23. reloadConfig – Техническая команда, перезагружающая конфигурацию. Временно отключена, чтобы заказчик случайно не нарушил работу. Алгоритм программы недоработан на текущий момент;
24. allowPostAgain – Команда, разрешающая повторное использование материалов, в случае если неиспользованных не осталось;
25. denyPostAgain – Команда, запрещающая повторное использование материалов, в случае если неиспользованных не осталось;
26. eraseConfig – Команда, выполняющая очистку текущей конфигурации и возвращение программы в нулевое состояние;
27. eraseLogs – Команда, выполняющая очистку записей журнала работы программы;
28. eraseAudios – Команда, выполняющая очистку локальной папки аудиозаписей;
29. eraseImages – Команда, выполняющая очистку локальной папки изображений;
30. eraseLocalfolder – Команда, выполняющая очистку всей локальной папки с материалами;
31. eraseDatafolder – Команда, выполняющая очистку всей папки приложения;
32. refill – Команда, выполняющая повторное сканирование локальной папки, помечая все материалы как неиспользованные. Алгоритм команды временно заблокирован для защиты от нарушения работы путем случайного выполнения программы;
33. restartLogger – Техническая команда, перезапускающая полностью модуль ведения журнала;
34. restartLongpoll – Техническая команда, выполняющая перезапуск модуля получения и обработки событий Telegram;
35. broadcastMessage – Команда, отправляющая сообщение всем пользователям из списка администраторов. Команда принимает строковый параметр равный тексту сообщения. Пример: broadcastMessage Внимание, сейчас будет перезапуск!;
36. test – Техническая команда, используемая при отладке приложения. При выполнении возвращает сообщение «ОК!». Если бот ничего не ответил на команду, то это свидетельствует о неполадках в работе одного из модулей;
37. help – Команда, выводящая весь список доступных команд и примеры их использования, за исключением отладочных команд;
